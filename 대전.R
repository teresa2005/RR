##############################################
#
#               ?????? ????????? 
# 
##############################################


########################################################################################
# 1. ????????? ????????? 
########################################################################################
# ????????? ???????????? 
data=read.table('?????????????????????_?????????.csv',sep=",",head=T,encoding='utf-8')
str(data) # ????????????
data_new=data # ??? ????????? ?????? 
data_new
str(data_new)


#############  EDA   ##############
# library
library(ggplot2)
#install.packages('ggExtra')
library(ggExtra)

# classic plot :
df1=subset(data_new, ???=='??????')
df2=subset(data_new, ???=='??????')
df3=subset(data_new, ???=='?????????')
df4=subset(data_new, ???=='?????????')
df5=subset(data_new, ???=='??????')
ggplot(df1, aes(x=?????????, y=???????????????,fill=?????????))+geom_bar(stat="identity")
ggplot(df2, aes(x=?????????, y=???????????????,fill=?????????))+geom_bar(stat="identity")
ggplot(df3, aes(x=?????????, y=???????????????,fill=?????????))+geom_bar(stat="identity")
ggplot(df4, aes(x=?????????, y=???????????????,fill=?????????))+geom_bar(stat="identity")
ggplot(df5, aes(x=?????????, y=???????????????,fill=?????????))+geom_bar(stat="identity")

ggplot(df1, aes(x=?????????, y=??????,fill=?????????))+geom_bar(stat="identity")
ggplot(df2, aes(x=?????????, y=??????,fill=?????????))+geom_bar(stat="identity")
ggplot(df3, aes(x=?????????, y=??????,fill=?????????))+geom_bar(stat="identity")
ggplot(df4, aes(x=?????????, y=??????,fill=?????????))+geom_bar(stat="identity")
ggplot(df5, aes(x=?????????, y=??????,fill=?????????))+geom_bar(stat="identity")+scale_y_continuous(limits = c(3, 5))



# ????????? ?????????????????? ?????? ?????? ????????? 
# MIN-MAX ????????? 
minmax=function(x){
  (x-min(x))/(max(x)-min(x))
}

data_new[,5:13]=apply(data_new[,5:13],MARGIN = 2, minmax) # margin 2=?????? ??????


# ????????? ??????????????? ???????????? ??????????????? ?????? ??????
# ???? ????????? ???????????? ????????? 3?????? ???
# ????????? ????????? ????????? 3~5????????? ????????? ????????? 
# ??????, ?????? ????????? ???????????? ???????????? ???????????? ????????? ??????????????? ??????????????????. 
# ?????? ??????, A,B?????? ?????? ????????? 5??? ???????????????, A??? ??????????????? 3, B??? ??????????????? 200??? ?????????
# B????????? ????????? ???????????? ????????????. 
# ????????? ??? ??????????????? ????????? min-abs??????, 0?????? ???????????? ????????? +1?????? 1.**?????? ???????????? ????????????. 
# ??? min-abs???? 
# MinMaxScaler???????????? ???????????? ?????? ???????????? ????????? ?????? ????????? ???????????? 1??????????????? ?????? ????????? ???????????? ????????? ??????. ???????????? ?????? ????????? ?????? ????????? ????????? ????????? ?????? ???????????? ???????????? ???????????? ????????? ?????????.
# MaxAbsScaler??? ??????, MinMaxScaler??? ???????????? ????????? ???????????? ?????? ?????? ????????? ???????????? ?????? ????????? ??????
# ??? ???????????? ??????????????? ?????????, ??????????????? ????????? ????????? ???????????? ????????? ????????? ??????????????? ?????????. 

# ??????=????????????*(1+maxabs(??????))
maxabs=function(x){
  x/max(x)
}
data_new[,3]=maxabs(data_new[,3])# ?????? ????????? 
data_new$??????=data_new[,4]*(data_new[,3]+1) # ?????? ?????? ?????? 
str(data_new) # ?????? ?????? ?????? 
summary(data_new$??????) # ?????? ????????? ??????????????? ??????  

# ??????, ?????? ????????? ?????? ????????? 6~520?????? ????????? ?????? ???????????? 
# ?????? ????????? 4???????????? ?????? ??????????????? scale???
quantile(data_new$??????) # 4????????? ??????

for (i in 1:79){
  if (data_new[i,14]< 71.476) data_new[i,14]=0
  if ((data_new[i,14]>= 71.476)&(data_new[i,14]<95.882)) data_new[i,14]=1
  if ((data_new[i,14]>=95.882)&(data_new[i,14]<146.454)) data_new[i,14]=2
  if (data_new[i,14]>=146.454) data_new[i,14]=3
}
table(data_new$??????)
str(data_new)
cor(data_new$??????,data_new$???????????????)  # ????????? ???????????? ???????????? 




########################################################################################
# 2. 1??? ???????????? ?????? : full model 
########################################################################################

# ???????????? : ?????? ????????? ??????????????? ???????????? ??????
# ??????: ??????????????? 0.1?????? ???????????????
# HO: B=0(??????????????? ???????????? ??????)
# ??????????????? ?????? ?????? ??? ????????????.???, ???4050???, ???2030???, ?????? ??? 4?????? ??????????????? ????????????. 
# ?????? ????????? R^2??? 0.78??? ???????????? ????????????,
# ????????? ???????????? ?????? p-value=2.2e-16??? ????????????(Ho:b1=...=bn=0)??? ????????????, ????????? ???????????? ????????????. 
model=lm(???????????????~., data=data_new[,5:14])
summary(model)
########################################################################################
# 3. 1??? ???????????????  
########################################################################################
# ????????? ??????????????? ???????????? ?????? ??????????????? ????????? ???????????????. 
# https://blog.naver.com/PostView.nhn?blogId=sharp_kiss&logNo=221816968163&redirect=Dlog&widgetTypeCall=true&directAccess=false
# ?????? : full model??? ?????? ?????? ?????????????????? vif ???????????? 10???????????? ?????????????????? ??????????????? ????????????. 
# ??? ??? ?????????????????? vif??? 10 ???????????? ?????? ??????. 
# ?????????, ???????????? ?????? ????????? ????????? ????????? ?????????????????? vif??? 5????????? ??????????????? ????????? ???????????? ?????????. 
# install.packages('car')
library(car)
vif(model)

########################################################################################
# 4. 2??? ???????????? ?????? : selected model 
########################################################################################
# ??????, ???????????? ??????????????? ????????? ???????????? ????????????. 
# ?????????, ?????? ????????? ?????????????????? ?????? ???????????????, ????????????????????? 
# '?????????????????? ?????? AIC??? ?????? ?????? ????????? ??????,????????????.???, 2030??? ??????
# ??? ??????, ???????????? a=0.1?????? ????????? ??????????????? ?????? ???????????????
# ????????????.???, ???2030???, ???????????????. 
# ??????, ????????? R^2=0.77??? ?????? full model?????? 0.01???????????????, ????????? ???????????? p-value=2.2e-16??? ????????????. 

step(model,direction = "backward")

model2=lm(???????????????~????????????.???+X2030???+??????, data=data_new[,5:14])
summary(model2)
########################################################################################
# 5. 2??? ??????????????? : selected model 
########################################################################################
# 2??? ???????????? ????????? ??????????????? ?????? ?????? 
# selected model??? ?????? ?????????????????? vif??? 10????????? ?????????????????? ???????????? ?????????. 
vif(model2)


########################################################################################
# 8. ???????????? ??????  
########################################################################################
# ?????? ?????? ?????? selected model??? ?????????????????? ???????????????. 
# ????????? y(????????????)??? ????????? ????????? ????????? ????????????.???, 2030???, ?????? ?????? ?????????. 
# ?????????, ????????? 3??? ????????? ???????????? ????????????????????? ????????????,
# ??? ????????? ???????????? ????????????, ???????????? ????????? ????????? ??? 
# y??? ???????????? ????????????????????? ???????????????. 

########################################################################################
# 9. ?????????????????? 
########################################################################################
# ??????, ????????? ?????? ????????????????????? ????????? ??????
# ????????????.?????? ?????????????????? 0.351
# 2030?????? ?????????????????? 1.308(?????? ?????????=>???????????? ??????.)
# ????????? ??????????????????  0.275
# ??? ??? 2030?????? ?????????????????? ?????? ?????? ?????? ??????.
# install.packages('randomForest')
library(randomForest)
df=data_new[,c('????????????.???','X2030???','??????','???????????????')]
str(df)
set.seed(123)
forest_m = randomForest(???????????????~????????????.???+X2030???+??????, data=df)
forest_m$importance


########################################################################################
# 10. ??????????????????  
########################################################################################
# ??????, ????????????????????? ?????? ???????????? ?????????(weiht)???????????? ?????? ?????? 
# ??????????????????=(0.351*????????????.???)+(1.308*???2030???)+( 0.275*??????)
# ????????????????????? ??????????????? ?????? ??????????????? 0.72??? ?????? ?????? ??????????????? ??????. 
# ???, ????????????????????? ???????????? ?????????????????? ????????? ???????????? ?????? ??????. 
# ?????? ?????????????????? ???????????? ????????????????????? ????????? ????????? ??? ??? ??????????????? ???????????? ????????? ??? ??? ??????. 
df$??????????????????=((0.352*df$????????????.???)+(1.312*df$X2030???)+( 0.276*df$??????))
head(df)
cor(df$??????????????????,df$???????????????) 
str(df)

########################################################################################
# 11. ????????????????????? ?????????????????? ?????? ?????? - ???????????? ???????????? 
########################################################################################
# ??????, ?????????????????? ?????????????????? ?????? ?????? ???????????? ????????? ?????????.
# ??? ???????????????, ???????????? ???????????? ?????? ??? ????????? k??????????????? ????????????
# ?????????????????????, ????????????.???, ???2030???, ???????????? ??????????????? ????????????????????? ?????? ????????? ??????????????? 
# ??????????????? ????????????, ???????????? ???????????? ?????????, ??? ????????? ????????? ?????? ????????? ??? ?????????
# ???????????? ?????? ??????????????????. 

######  ??????????????? ######
set.seed(123) # ?????? ?????? 

# ????????? K?????? ?????? - ????????? 
# ????????? ??????(The Elbow Method)?????? ????????? k????????? ?????? ?????? 
# k=5?????? ???????????? ????????? ???????????? ????????? ???????????? ??? ??? ??????. 
# ????????? ??????????????? 5?????? ???????????????. 
visual <- NULL
for(i in 2:10) 
{
  set.seed(123) 
  eval(parse(text=paste("result",i,"<- kmeans(df[,4],",i,");",sep=""))) 
  eval(parse(text=paste("visual[",i,"] <- result",i,"$tot.withinss",sep=""))) 
}
plot(visual[-1], type="l", ylab="", xlab="", main="cluster??? ????????? ????????? ?????????") 
abline(v=3,col="red") # ?????????




# ???????????? 3??? ?????? 
set.seed(123)
str(df)
km3=kmeans(df[,4],3)  # ??????????????? ????????? ?????? ????????????

# ????????? ??????
kclust_data=df  
kclust_data$clust=km3$cluster # ?????? ?????? ?????? 
table(kclust_data$clust) 
# ?????? ????????? r_mean??? ????????? ????????? ?????????????????? ????????? ?????? ?????? ????????? 
kclust_data$clust1[kclust_data$clust==3]=1
kclust_data$clust1[kclust_data$clust==2]=3
kclust_data$clust1[kclust_data$clust==1]=2
table(kclust_data$clust1) 
# clust1????????? ?????? ?????? ?????? 
kclust_data1=kclust_data[,c('????????????.???','X2030???','??????','??????????????????','???????????????','clust1')]
str(kclust_data1)

## ???????????? - ????????? 
# install.packages('fmsb')
library(fmsb) # ???????????? ?????? ??????????????? 
str(kclust_data)
r_mean=aggregate(.~clust1,data=kclust_data1[,1:6],mean) # ???????????? ?????? ?????? 1 : ??? ????????? ?????? ???????????? ?????? (??????????????????)
r_mean

r_max=as.data.frame(apply(kclust_data1[,1:5],2,max)) # ???????????? ?????? ?????? 2 :??? ????????? ?????? ???????????? ????????? 
r_min=as.data.frame(apply(kclust_data1[,1:5],2,min))# ???????????? ?????? ?????? 3 :??? ????????? ?????? ???????????? ????????? 
data=rbind(t(r_max),t(r_min),r_mean[,-1])# ???????????? ?????? ?????? 1~3??? ???????????? ????????? ?????? ????????? 

# ????????? ????????? 
par(mfrow=c(1,1))
#????????????
colors_border=c( rgb(0.8,0.2,0.5,0.9) ,rgb(0.2,0.5,0.5,0.9), rgb(0.9,0.6,0.1,0.9) )
colors_in=c( rgb(0.8,0.2,0.5,0.7) ,rgb(0.2,0.5,0.5,0.4), rgb(0.9,0.6,0.1,0.2) )
radarchart(df=data, # ????????????:????????? ????????????:?????????, ??? ???????????? ??????????????? ?????? ??? ?????? 
           axistype=1,
           #custom polygon
           pcol=colors_border , pfcol=colors_in , plwd=4 , plty=1,
           #custom labels
           cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,20,5), cglwd=0.8,
           vlcex=0.8,
           title=c("????????????????????? ?????????????????? ??????"))


legend("topleft", legend = c('????????????','????????????','????????????'), bty = "n", pch=20 , col=colors_in , text.col = "grey", cex=1.2, pt.cex=3)



########################################################################################
# 12. ????????????????????? ?????????????????? ?????? ?????? - ???????????? ???????????? ?????? 
########################################################################################
# ??????, ????????? ????????? ????????? ????????????????????? ?????????????????? ???????????? ?????? ????????????. 




#############################################
# 13. ????????????
# ??????????????? ?????? 1=????????????, 2=????????????,3=????????????
# ???????????? ???????????????.
# ??? ??????????????? ????????? ????????? ?????? 
# ?????? ????????????????????? ??????
#############################################
# ??????????????? ????????????????????? ?????? 
library(dplyr)
kclust_data1=rename(kclust_data1,"????????????"='clust1')
str(kclust_data1)

????????????????????? ?????? 1=>??????, 2=>??????, 3=>???????????? ?????? 
kclust_data1$????????????[kclust_data1$????????????==1]='??????' 
kclust_data1$????????????[kclust_data1$????????????==2]='??????'
kclust_data1$????????????[kclust_data1$????????????==3]='??????' 
kclust_data1$????????????=factor(kclust_data1$????????????, levels=c('??????','??????','??????'))

library(randomForest)
rf=randomForest(???????????? ~ ., data=kclust_data1)

# ???????????? pred=???????????????????????? ????????? ?????? ?????? 
kclust_data1$pred=rf$predicted
str(kclust_data1)

# ???????????? ???????????? 
tt=rf$confusion

# ???????????? ??? ???????????? ?????? 
sum(tt[row(tt) == col(tt)])/sum(tt)#????????????
1-sum(tt[row(tt) == col(tt)])/sum(tt) #????????????

# ????????? 
library(ggplot2)
dev.off()
ggplot(kclust_data1, aes(????????????, pred, color = ????????????))+
 geom_jitter(width = 0.2, height = 0.1, size=2) +
 labs(title="?????? 79??? ????????? ???????????? ????????????",y="??????", x="??????")+
 theme_light() +
 theme(plot.title=element_text(size=20,hjust= 0.5))


########  ??????!!!!!!!!! ????????? ?????? ########
# write.csv(kclust_data1,'????????????.csv')











##############################################################################################################################      
#####################                                    ??? ?????? ?????????                                    ###################
##############################################################################################################################



#install.packages("ggmap")
#install.packages("raster")
#install.packages("rgeos")
#install.packages("maptools")
#install.packages("rgdal")
library(ggmap)
library(ggplot2)
library(raster)
library(rgeos)
library(maptools)
library(rgdal)
library(ggplot2)

#####################  ??? ?????? ????????? ###################
data=read.table('?????????????????????_?????????.csv',sep=",",head=T,encoding='utf-8')
str(data) # ????????????

# kclust_data1??? ?????? ????????? ?????? ?????? 
kclust_data1$???=data$???
kclust_data1$?????????=data$?????????
str(kclust_data1)

# ?????? ?????? ??????
ds=kclust_data1[,c(1,2,3,4,5,8)]
d_mean=aggregate(.~???,data=ds,mean) 
d_mean

# ?????? ?????? id??? kclust_data1??? ??????
gg=read.csv('?????????id.csv')
head(gg)
fdata=merge(d_mean,gg, by='???')
fdata$id=(fdata$id*10)
str(fdata)


# ?????? ??? 
map = readOGR("TL_SCCO_SIG.shp")
new_map = fortify(map, region = 'SIG_CD')
df_map_info = map@data  # ??????????????? ID ?????? 
head(df_map_info)
# 119  30110                     Dong-gu              ??????
# 120  30140                     Jung-gu              ??????
# 121  30170                      Seo-gu              ??????
# 122  30200                  Yuseong-gu            ?????????
# 123  30230                  Daedeok-gu            ?????????
str(new_map)
new_map$id = as.numeric(new_map$id)
DD=subset(new_map, id>=30110&id<=30230)  # ?????? ?????? ???????????? id??? ??????
max(DD$id)

#df_map_info 
P_merge = merge(DD,fdata,  by='id')
str(P_merge)

############################################ ?????? ??????????????? ##############################
# *??????* ????????? ????????? ??? ??????! 
gu_name=aggregate(.~???,data=P_merge,mean)
gu_name

ggplot() + geom_polygon(data = P_merge, aes(x = long,y = lat, group = group,fill =???????????????), color = "#005666") + 
  scale_fill_gradient(low =  "#e5fafa",high = '#0b5b5a' , 
                      space = "Lab", guide = "colourbar") + 
  labs(fill = "???????????????",title = "????????? ?????? ?????? ?????????") + theme_void() +
  theme(legend.position = c(.15, .85),plot.title=element_text(size=20,hjust= 0.5,face = 'bold')) +
  geom_text(data = gu_name, aes(x = long,y = lat,label = paste(???, sep = "\n")),size=7,fontface = 'bold',color='#292929')

############################################ ?????? ??????????????????  ##############################
ggplot() + geom_polygon(data = P_merge, aes(x = long,y = lat, group = group,fill =??????????????????), color = "#eb5e42") + 
  scale_fill_gradient(low =  "#ffddd7",high = '#ff8f79' , 
                      space = "Lab", guide = "colourbar") + 
  labs(fill = "???????????????",title = "????????? ?????? ??????????????????") + theme_void() +
  theme(legend.position = c(.15, .85),plot.title=element_text(size=20,hjust= 0.5,face = 'bold')) +
  geom_text(data = gu_name, aes(x = long,y = lat,label = paste(???, sep = "\n")),size=7,fontface = 'bold',color='#292929')






